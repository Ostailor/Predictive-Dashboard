{% extends "base.html" %}

{% block title %}Sales Overview - Predictive Dashboard{% endblock %}

{% block head_scripts %}
    {{ super() }}
    <script>
        console.log("Sales overview HEAD_SCRIPTS block processed.");
    </script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
        #salesOverviewContentWrapper {
            position: relative; 
            min-height: 500px; 
        }

        #salesOverviewContentWrapper.content-blurred-for-plot {
            filter: blur(4px);
            transition: filter 0.15s linear;
        }

        #plotRenderOverlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.85); 
            display: none; /* Initially hidden */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            text-align: center;
        }

        #plotRenderOverlay .progress {
            width: 60%; 
            max-width: 400px; 
            margin-bottom: 20px;
            height: 1.75rem; 
            background-color: #e9ecef; 
            border-radius: .375rem; 
        }
        
        #plotRenderOverlay .progress-bar {
            font-size: 0.9rem; 
            font-weight: 500;
            color: white; 
        }

        #plotRenderOverlay p {
            font-size: 1.25em; 
            color: #343a40; 
            font-weight: 500;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4" id="salesOverviewContentWrapper"> 
    <!-- ADD THE OVERLAY DIV HERE -->
    <div id="plotRenderOverlay">
        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
        </div>
        <p>Loading data and generating charts...</p>
    </div>

    <h2 id="salesOverviewPageTitle">Sales Performance Analysis</h2> 

    <!-- Filter Form - Give it an ID -->
    <form method="GET" action="{{ url_for('main.sales_overview') }}" class="mb-3 form-inline" id="filterForm">
        <div class="form-group mr-2">
            <label for="store" class="mr-1">Store:</label>
            <select name="store" id="store" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for store_val in filter_options.stores %}
                    <option value="{{ store_val }}" {% if store_val|string == selected_store|string %}selected{% endif %}>
                        {{ store_val }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group mr-2">
            <label for="item" class="mr-1">Item:</label>
            <select name="item" id="item" class="form-control form-control-sm" onchange="this.form.submit()">
                 {% if filter_options and 'items' in filter_options and filter_options['items'] is iterable %}
                    {% for item_val in filter_options['items'] %}
                        <option value="{{ item_val }}" {% if item_val|string == selected_item|string %}selected{% endif %}>
                            {{ item_val }}
                        </option>
                    {% endfor %}
                {% else %}
                    <option value="">Error: Items not available</option>
                {% endif %}
            </select>
        </div>
    </form>
    <!-- End Filter Form -->

    {% if model_mse and model_mse != "N/A" %}
    <p class="text-muted small">Current RF Model Test MSE: {{ model_mse }}</p>
    {% endif %}

    {% if graph_json %}
    <div class="row">
        <div class="col-md-12">
            <div id="salesForecastChart" class="chart-container mb-4"></div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        No sales forecast data to display. Please check filters or data availability.
    </div>
    {% endif %}

    {% if feature_importance_plot_json %}
    <div class="row mt-4">
        <div class="col-md-12">
            <h3 id="featureImportanceTitle">Model Feature Importances</h3>
            <div id="featureImportanceChart" class="chart-container"></div>
        </div>
    </div>
    {% elif rf_model %}
    <div class="alert alert-warning mt-4" role="alert">
        Feature importance data is not available for the current model.
    </div>
    {% endif %} 

    <!-- Seasonal Decomposition Section -->
    {% if decomposition_plots_json and (decomposition_plots_json.trend or decomposition_plots_json.seasonal or decomposition_plots_json.residual) %}
    <div class="card mb-4">
        <div class="card-header">
            Time Series Decomposition
        </div>
        <div class="card-body">
            <p>The sales data has been decomposed into trend, seasonal, and residual components. This helps in understanding underlying patterns.</p>
            <div class="row">
                {% if decomposition_plots_json.trend %}
                <div class="col-md-12 mb-3"> <!-- Changed to full width for better display -->
                    <div id="trendChart"></div>
                </div>
                {% endif %}
                {% if decomposition_plots_json.seasonal %}
                <div class="col-md-12 mb-3"> <!-- Changed to full width -->
                    <div id="seasonalChart"></div>
                </div>
                {% endif %}
                {% if decomposition_plots_json.residual %}
                <div class="col-md-12"> <!-- Changed to full width -->
                    <div id="residualChart"></div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% elif graph_json %} <!-- Show this message only if main graph exists but decomposition doesn't -->
    <div class="alert alert-info" role="alert">
        Seasonal decomposition could not be performed for the selected cohort, possibly due to insufficient data or data characteristics.
    </div>
    {% endif %}

</div>
{% endblock %}

{% block body_scripts %} 
<script>
    console.log("Sales overview BODY_SCRIPTS block processed."); 

    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded event fired.");

        const contentWrapper = document.getElementById('salesOverviewContentWrapper');
        const overlay = document.getElementById('plotRenderOverlay');
        const filterForm = document.getElementById('filterForm');

        function showLoader() {
            if (overlay) overlay.style.display = 'flex';
            if (contentWrapper) contentWrapper.classList.add('content-blurred-for-plot');
            console.log("Loader shown.");
        }

        function hideLoader() {
            if (overlay) overlay.style.display = 'none';
            if (contentWrapper) contentWrapper.classList.remove('content-blurred-for-plot');
            console.log("Loader hidden.");
        }

        showLoader();

        if (filterForm) {
            filterForm.addEventListener('submit', function() {
                console.log("Filter form submitted, showing loader.");
                showLoader();
            });
        }
        
        try {
            var salesGraphJsonString = {{ graph_json|tojson|safe if graph_json else 'null' }};
            var featureImportanceJsonString = {{ feature_importance_plot_json|tojson|safe if feature_importance_plot_json else 'null' }};
            var decompositionPlotsJsonString = {{ decomposition_plots_json|tojson|safe if decomposition_plots_json else 'null' }};

            console.log("Raw salesGraphJsonString:", salesGraphJsonString);
            console.log("Raw featureImportanceJsonString:", featureImportanceJsonString);
            console.log("Raw decompositionPlotsJsonString:", decompositionPlotsJsonString);

            var salesGraphJson = null;
            if (salesGraphJsonString && salesGraphJsonString !== 'null') {
                try {
                    salesGraphJson = JSON.parse(salesGraphJsonString);
                    console.log("Parsed salesGraphJson:", salesGraphJson);
                } catch (e) {
                    console.error("Error parsing salesGraphJson:", e, salesGraphJsonString);
                }
            }

            if (salesGraphJson && salesGraphJson.data && salesGraphJson.layout) {
                Plotly.newPlot('salesForecastChart', salesGraphJson.data, salesGraphJson.layout, {responsive: true});
                console.log("Sales forecast chart plotted.");
            } else {
                console.log("Sales forecast chart NOT plotted. salesGraphJson:", salesGraphJson);
            }

            var featureImportanceJson = null;
            if (featureImportanceJsonString && featureImportanceJsonString !== 'null') {
                try {
                    featureImportanceJson = JSON.parse(featureImportanceJsonString);
                    console.log("Parsed featureImportanceJson:", featureImportanceJson);
                } catch (e) {
                    console.error("Error parsing featureImportanceJson:", e, featureImportanceJsonString);
                }
            }

            if (featureImportanceJson && featureImportanceJson.data && featureImportanceJson.layout) {
                Plotly.newPlot('featureImportanceChart', featureImportanceJson.data, featureImportanceJson.layout, {responsive: true});
                console.log("Feature importance chart plotted.");
            } else {
                console.log("Feature importance chart NOT plotted. featureImportanceJson:", featureImportanceJson);
            }

            // --- SECTION FOR DECOMPOSITION PLOTS (REVISED FOR DETAILED LOGGING) ---
            var decompositionPlots = null;

            // Check if decompositionPlotsJsonString is already an object (from Jinja's |tojson|safe)
            // or if it's a string that needs parsing.
            if (typeof decompositionPlotsJsonString === 'object' && decompositionPlotsJsonString !== null) {
                decompositionPlots = decompositionPlotsJsonString; // It's already an object
                console.log("Decomposition data is already an object, using directly:", JSON.parse(JSON.stringify(decompositionPlots)));
            } else if (typeof decompositionPlotsJsonString === 'string' && decompositionPlotsJsonString.trim() !== "" && decompositionPlotsJsonString !== 'null') {
                try {
                    decompositionPlots = JSON.parse(decompositionPlotsJsonString); // It's a string, parse it
                    console.log("Parsed decompositionPlotsJsonString (string to object):", JSON.parse(JSON.stringify(decompositionPlots)));
                } catch (e) {
                    console.error("Error parsing string decompositionPlotsJsonString:", e, "Value snippet:", decompositionPlotsJsonString.substring(0,200)+"...");
                    decompositionPlots = null; // Ensure it's null if parsing fails
                }
            } else {
                console.log("Decomposition plots data (decompositionPlotsJsonString) is null, empty, or not a recognized type. No plots to render. Value:", decompositionPlotsJsonString);
            }

            if (decompositionPlots) { // Proceed only if decompositionPlots is a valid object
                // Plot Trend
                if (decompositionPlots.hasOwnProperty('trend') && typeof decompositionPlots.trend === 'string' && decompositionPlots.trend.length > 2 && document.getElementById('trendChart')) {
                    console.log("Attempting to plot Trend. JSON string:", decompositionPlots.trend.substring(0,100) + "...");
                    try {
                        let trendPlotJson = JSON.parse(decompositionPlots.trend);
                        if (trendPlotJson && typeof trendPlotJson === 'object' && trendPlotJson.data && trendPlotJson.layout) {
                            Plotly.newPlot('trendChart', trendPlotJson.data, trendPlotJson.layout, {responsive: true});
                            console.log("Trend chart successfully plotted.");
                        } else {
                            console.warn("Trend chart NOT plotted. Parsed trendPlotJson is invalid or missing data/layout. Value:", trendPlotJson);
                        }
                    } catch (e_trend) {
                        console.error("Error parsing JSON for decompositionPlots.trend:", e_trend, "Value snippet:", (typeof decompositionPlots.trend === 'string' ? decompositionPlots.trend.substring(0,100) + "..." : "[Trend data not a string]"));
                    }
                } else {
                    console.warn("Trend plot rendering skipped. Conditions not met or div not found.");
                    if (decompositionPlots && decompositionPlots.hasOwnProperty('trend')) {
                         console.log("  - decompositionPlots.hasOwnProperty('trend'):", true);
                         console.log("  - typeof decompositionPlots.trend:", typeof decompositionPlots.trend);
                         console.log("  - decompositionPlots.trend.length > 2:", (typeof decompositionPlots.trend === 'string' ? decompositionPlots.trend.length > 2 : 'N/A'));
                    } else if (decompositionPlots) {
                        console.log("  - decompositionPlots.hasOwnProperty('trend'):", false);
                    }
                    console.log("  - document.getElementById('trendChart'):", !!document.getElementById('trendChart'));
                }

                // Plot Seasonal
                if (decompositionPlots.hasOwnProperty('seasonal') && typeof decompositionPlots.seasonal === 'string' && decompositionPlots.seasonal.length > 2 && document.getElementById('seasonalChart')) {
                    console.log("Attempting to plot Seasonal. JSON string:", decompositionPlots.seasonal.substring(0,100) + "...");
                    try {
                        let seasonalPlotJson = JSON.parse(decompositionPlots.seasonal);
                        if (seasonalPlotJson && typeof seasonalPlotJson === 'object' && seasonalPlotJson.data && seasonalPlotJson.layout) {
                            Plotly.newPlot('seasonalChart', seasonalPlotJson.data, seasonalPlotJson.layout, {responsive: true});
                            console.log("Seasonal chart successfully plotted.");
                        } else {
                            console.warn("Seasonal chart NOT plotted. Parsed seasonalPlotJson is invalid or missing data/layout. Value:", seasonalPlotJson);
                        }
                    } catch (e_seasonal) {
                        console.error("Error parsing JSON for decompositionPlots.seasonal:", e_seasonal, "Value snippet:", (typeof decompositionPlots.seasonal === 'string' ? decompositionPlots.seasonal.substring(0,100) + "..." : "[Seasonal data not a string]"));
                    }
                } else {
                    console.warn("Seasonal plot rendering skipped. Conditions not met or div not found.");
                     if (decompositionPlots && decompositionPlots.hasOwnProperty('seasonal')) {
                        console.log("  - decompositionPlots.hasOwnProperty('seasonal'):", true);
                        console.log("  - typeof decompositionPlots.seasonal:", typeof decompositionPlots.seasonal);
                        console.log("  - decompositionPlots.seasonal.length > 2:", (typeof decompositionPlots.seasonal === 'string' ? decompositionPlots.seasonal.length > 2 : 'N/A'));
                    } else if (decompositionPlots) {
                        console.log("  - decompositionPlots.hasOwnProperty('seasonal'):", false);
                    }
                    console.log("  - document.getElementById('seasonalChart'):", !!document.getElementById('seasonalChart'));
                }

                // Plot Residual
                if (decompositionPlots.hasOwnProperty('residual') && typeof decompositionPlots.residual === 'string' && decompositionPlots.residual.length > 2 && document.getElementById('residualChart')) {
                    console.log("Attempting to plot Residual. JSON string:", decompositionPlots.residual.substring(0,100) + "...");
                    try {
                        let residualPlotJson = JSON.parse(decompositionPlots.residual);
                        if (residualPlotJson && typeof residualPlotJson === 'object' && residualPlotJson.data && residualPlotJson.layout) {
                            Plotly.newPlot('residualChart', residualPlotJson.data, residualPlotJson.layout, {responsive: true});
                            console.log("Residual chart successfully plotted.");
                        } else {
                            console.warn("Residual chart NOT plotted. Parsed residualPlotJson is invalid or missing data/layout. Value:", residualPlotJson);
                        }
                    } catch (e_residual) {
                        console.error("Error parsing JSON for decompositionPlots.residual:", e_residual, "Value snippet:", (typeof decompositionPlots.residual === 'string' ? decompositionPlots.residual.substring(0,100) + "..." : "[Residual data not a string]"));
                    }
                } else {
                    console.warn("Residual plot rendering skipped. Conditions not met or div not found.");
                    if (decompositionPlots && decompositionPlots.hasOwnProperty('residual')) {
                        console.log("  - decompositionPlots.hasOwnProperty('residual'):", true);
                        console.log("  - typeof decompositionPlots.residual:", typeof decompositionPlots.residual);
                        console.log("  - decompositionPlots.residual.length > 2:", (typeof decompositionPlots.residual === 'string' ? decompositionPlots.residual.length > 2 : 'N/A'));
                    } else if (decompositionPlots) {
                        console.log("  - decompositionPlots.hasOwnProperty('residual'):", false);
                    }
                    console.log("  - document.getElementById('residualChart'):", !!document.getElementById('residualChart'));
                }
            }
            // --- END OF SECTION FOR DECOMPOSITION PLOTS ---

        } finally {
            setTimeout(hideLoader, 100); 
        }
    });
</script>
{% endblock %}